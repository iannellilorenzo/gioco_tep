<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Chi vuol essere milionario!</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  </head>
  <body>
    <header class="head">
      <h1><a href="index.html">Chi vuol essere milionario!</a></h1>
    </header>
    <div class="container cont">
      <div style="text-align:center; padding-top: 20px">
        <h2>Ti sei unito alla partita</h2>
      </div>
      <div id="gioco">
        <div id="step1"> <!-- il gioco è gestito in step, dove ogni step corrisponde a una domanda, da -->
          <div class="question">
            <h4 id="valoreDomanda"></h4>
            <div id="testoDomanda">
              <!-- qua viene scritto il testo della domanda grazie allo script -->
            </div>
          </div>
          <div id="risposte" class="d-flex flex-column align-items-center justify-content-center">
            <div class="row justify-content-around mb-2">
              <div class="col-sm-5 d-flex justify-content-center">
                <button class="risposta btn btn-warning rounded-pill btn-lg fixed-size-button" id="risposta1" onclick="answered(1)">Answer 1</button>
              </div>
              <div class="col-sm-5 d-flex justify-content-center">
                <button class="risposta btn btn-warning rounded-pill btn-lg fixed-size-button" id="risposta2" onclick="answered(2)">Answer 2</button>
              </div>
            </div>
            <div class="row justify-content-around">
              <div class="col-sm-5 d-flex justify-content-center">
                <button class="risposta btn btn-warning rounded-pill btn-lg fixed-size-button" id="risposta3" onclick="answered(3)">Answer 3</button>
              </div>
              <div class="col-sm-5 d-flex justify-content-center">
                <button class="risposta btn btn-warning rounded-pill btn-lg fixed-size-button" id="risposta4" onclick="answered(4)">Answer 4</button>
              </div>
            </div>
          </div>
        </div>
        <div id="correctAnswerModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="correctAnswerModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
              <div class="modal-body">
                <h2 id="modal-message" class="text-center"></h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br><br><br>
    <footer>
      <div>© 2024 Chi vuol essere milionario! Tutti i diritti riservati.</div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <script src="../js/script.js"></script>
    <script>
      var stepId = 0; // stepId è l'id della domanda, zero-based, da cui traggo anche le risposte
      var minQuestionID = Math.floor(rng(1, 46)); // le domande vanno da 'minQuestionID' a 'minQuestionID' + 15
      const maxQuestionID = minQuestionID + 15;
      const money = { "domanda0": "0", // array per dire quanto vale ogni domanda
        "domanda1": "500", "domanda2": "1.000", "domanda3": "1.500", "domanda4": "2.000", "domanda5": "3.000", 
        "domanda6": "5.000", "domanda7": "7.000", "domanda8": "10.000", "domanda9": "15.000", "domanda10": "20.000",
        "domanda11": "30.000", "domanda12": "70.000", "domanda13": "150.000", "domanda14": "300.000", "domanda15": "1.000.000"
      };  // array per dire quanto vale ogni domanda
      var index = minQuestionID - 1;

      function rng(min, max) {
        return Math.random() * (max - min) + min;
      }

      let quest;

      window.onload = async function() {
        const path = "../assets/domande_risposte.json";
        const response = await fetch(path);
        quest = await response.json();
      }

      async function getQuestion() {
        const myHeaders = new Headers();
        myHeaders.append("Authorization", "Basic NElFOlRpcm9uaQ==");

        const requestOptions = {
          method: "GET",
          headers: myHeaders,
          redirect: "follow"
        };
// sta roba la deve fare la newgame, perché è quella che ha accesso dopo, ovvero solo dopo che premo il bottone
        const gameId = await getGameID() - 1;
        const result = await fetch(`https://classe5ID.altervista.org/games/mossa/${gameId}/`, requestOptions);
        const risultato = await result.json();
        risultato.data.play = minQuestionID - 1;
        console.log(risultato);

        const questionsInRange = quest.slice(minQuestionID - 1, maxQuestionID - 1);
        document.getElementById("valoreDomanda").innerText = `Domanda ${stepId + 1} dal valore di €${money[`domanda${stepId + 1}`]}`; // stepId è zero-based, quindi aggiungo 1 per ottenere il valore corretto
        document.getElementById("testoDomanda").innerText = questionsInRange[stepId].domanda;
        return questionsInRange;
      }

      async function getAnswers() {
        let supportArray = []; // array di supporto per la randomizzazione delle domande
        const questAnsw = await getQuestion();
        for (let i = 1; i <= 4; i++) {
          let answIndex;
          let randomNum;
          do {
            randomNum = Math.floor(rng(1, 5));
            answIndex = `risposta${randomNum}`;
          } while (supportArray.includes(randomNum));
          supportArray.push(randomNum);
          document.getElementById(`risposta${i}`).innerText = questAnsw[stepId][answIndex];
        }
      }


      $(document).ready(function() {
        $('#correctAnswerModal').modal({show:false});
        getAnswers();
      });

      function showHideModal() {
        $('#correctAnswerModal').modal('show');
        setTimeout(function() {
          $('#correctAnswerModal').modal('hide');
        }, 2000);
      }

      function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }
      
      async function answered(answerId) {
        let buttons = document.getElementsByClassName('risposta');
        for (let i = 0; i < buttons.length; i++) {
          buttons[i].classList.add('no-click');
        }

        const answ = document.getElementById(`risposta${answerId}`);
        answ.classList.add('blue-flash');
        const answText = answ.innerText;
        answ.innerText = "L'accendiamo...?";
        
        const modal = document.getElementById('modal-message');
        const currentIndex = index;

        setTimeout(async function() {
          answ.classList.remove('blue-flash');
          answ.innerText = answText;
          if (quest[currentIndex].risposta1 === answText) {
            for (let i = 0; i < buttons.length; i++) {
              buttons[i].classList.remove('no-click');
            }
            index++;
            stepId++;
            modal.style.color = "green";
            modal.innerText = "Risposta corretta!";
            showHideModal();
            nextStep();
          } else {
            modal.style.color = "red";
            modal.innerText = "Risposta sbagliata!";
            showHideModal();

            await delay(2000);

            let doc = document.getElementsByClassName('cont')[0];
            doc.innerHTML = "";
            let gameOver = document.createElement("h1");
            gameOver.style.textAlign = "center";
            gameOver.style.padding = "50px";
            gameOver.style.color = "red";
            gameOver.innerText = "Hai perso! La tua vincita è di €" + money[`domanda${stepId}`];
            doc.appendChild(gameOver);
          }
        }, 2000);
      }

      async function nextStep() {
        if (stepId < 15) {
          getAnswers();
        } else {
          await delay(2000);

          let doc = document.getElementsByClassName('cont')[0];
          doc.innerHTML = "";
          let gameOver = document.createElement("h1");
          gameOver.style.textAlign = "center";
          gameOver.style.padding = "50px";
          gameOver.style.color = "green";
          gameOver.innerText = "Hai vinto! La tua vincita è di €" + money[`domanda${stepId}`];
          doc.appendChild(gameOver);
        }
      }
      
    </script>
  
    
  </body>
</html>